<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>oGame Calculadora de Astrofísica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="A tua ferramenta para calcular o custo da Astrofísica." />

  <style>

    :root {
      --bg: #10131c;
      --bg2: #181c28;
      --bg3: #222636;
      --accent: #63b4ff;
      --accent-soft: rgba(99, 180, 255, 0.2);
      --danger: #ff8080;
      --text: #e5e9f5;
      --muted: #a2abc4;
      --border: #2c3243;
      --shadow-soft: 0 18px 32px rgba(0, 0, 0, 0.65);
    }

    /* Tema Carbon */
    body.theme-carbon {}

    /* Tema Neon */
    body.theme-neon {
      --bg: #02030a;
      --bg2: #070b1c;
      --bg3: #0a1024;
      --accent: #7cfbff;
      --accent-soft: rgba(124, 251, 255, 0.2);
      --danger: #ff7b7b;
      --text: #f5f7ff;
      --muted: #9aa7d4;
      --border: #323e68;
      --shadow-soft: 0 26px 46px rgba(0, 0, 0, 0.9);
      background: radial-gradient(circle at top, #171c3c 0%, #02030a 60%);
    }

    /* Tema Light (iOS) */
    body.theme-light {
      --bg: #f5f5f7;
      --bg2: #ffffff;
      --bg3: #f2f2f7;
      --accent: #007aff;
      --accent-soft: rgba(0, 122, 255, 0.18);
      --danger: #ff3b30;
      --text: #1c1c1e;
      --muted: #6c6c70;
      --border: #d1d1d6;
      --shadow-soft: 0 10px 20px rgba(0, 0, 0, 0.08);
      background: radial-gradient(circle at top, #ffffff 0%, #f5f5f7 55%);
    }

    body.theme-light .icon {
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #007aff 40%, #d1d1d6 85%);
      box-shadow: 0 0 12px rgba(0, 122, 255, 0.55);
    }

    body.theme-light .card {
      backdrop-filter: blur(18px);
    }

    body.theme-light thead th {
      color: #3a3a3c;
      border-bottom-color: #d1d1d6;
    }

    body.theme-light tbody tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.02);
    }

    body.theme-light .kpi {
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 8px 14px rgba(0, 0, 0, 0.05);
    }

    body.theme-light .pill {
      background: rgba(0, 122, 255, 0.06);
      color: #1c1c1e;
    }

    body.theme-light .pill.danger {
      background: rgba(255, 59, 48, 0.08);
      color: #8e0000;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      margin-bottom: 18px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .icon {
      display: inline-block;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      margin-right: 6px;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #63b4ff 35%, #020617 80%);
      box-shadow: 0 0 18px rgba(99, 180, 255, 0.8);
      vertical-align: middle;
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
    }

    .theme-switcher {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .theme-switcher label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
    }

    .theme-select {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid var(--accent);
      cursor: pointer;
      background-color: var(--bg3) !important;
      color: var(--text) !important;
      outline: none;
      appearance: none;
    }

    /* Small input field (used for % destroços) */
    .input-small {
      max-width: 120px;
    }
    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    input[readonly] {
      opacity: 0.9;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 2fr);
      gap: 16px;
    }

    .left-col,
    .right-col {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (max-width: 900px) {
      body {
        padding: 12px;
      }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg2);
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .card-kicker {
      font-size: 11px;
      color: var(--muted);
    }

    .card-section {
      display: grid;
      gap: 8px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: 120px repeat(3, minmax(0, 1fr));
      gap: 8px;
      align-items: end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    .field label {
      color: var(--muted);
    }

    input,
    select {
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    .warning {
      border-color: var(--danger) !important;
      color: var(--danger);
    }

    .controls-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #4a9dff);
      color: #020617;
      font-weight: 600;
    }

    .btn-primary:hover {
      filter: brightness(1.08);
    }

    .btn-secondary {
      background: transparent;
      border-color: var(--muted);
      color: var(--muted);
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
    }

    .btn-danger {
      border-radius: 6px;
      border: 1px solid #ff7b7b;
      background: transparent;
      color: #ff9b9b;
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: rgba(255, 123, 123, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th,
    td {
      padding: 4px 6px;
      text-align: left;
    }

    thead th {
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    tfoot td {
      border-top: 1px solid var(--border);
      font-weight: 600;
      color: var(--muted);
    }

    .fleet-input-cell input {
      width: 110px;
    }

    .narrow {
      white-space: nowrap;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .kpi {
      background: var(--bg3);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(255, 255, 255, 0.02);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
    }

    body.theme-light .kpi {
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 8px 14px rgba(0, 0, 0, 0.05);
    }

    .kpi-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 15px;
      font-weight: 600;
    }

    .status-block {
      border-radius: 10px;
      background: var(--bg3);
      padding: 10px 10px 8px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    body.theme-light .status-block {
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .status-block h3 {
      margin: 0 0 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .status-block > div > div {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
    }

    .status-block span:first-child {
      color: var(--muted);
    }

    .pill {
      margin-top: 4px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background: rgba(148, 163, 184, 0.12);
      color: var(--text);
    }

    .pill.danger {
      background: rgba(255, 123, 123, 0.12);
      color: #fecaca;
    }

    .footer {
      margin-top: 18px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .footer span {
      opacity: 0.85;
    }
	
	.capacity-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 8px;
  background: var(--bg3);
  font-size: 12px;
  color: var(--text);
}

.theme-light .capacity-row {
  background: #ffffff;
  border: 1px solid #d1d1d6;
}

.cap-icon {
  font-size: 14px;
  opacity: 0.9;
}

.cap-label {
  font-weight: 600;
  color: var(--text);
}

.theme-light .cap-label {
  color: #1c1c1e;
}

.cap-msg {
  color: var(--muted);
}

.cap-value {
  margin-left: auto;
  font-weight: 700;
  color: var(--text);
}

.theme-light .cap-value {
  color: #1c1c1e;
}

  </style>
</head>
<body class="theme-neon">
<div class="page">
  <div class="top-row">
    <div class="title-block">
      <h1><span class="icon"></span> oGame AstroCalculator v2.0</h1>
      <div class="subtitle">
        Planeamento de astrofísica, abate de frota, destroços, produção, armazéns, trocas e matéria negra.
      </div>
    </div>
    <div class="theme-switcher">
      <label for="themeSelect">Tema</label>
      <select id="themeSelect" class="theme-select" onchange="setTheme(this.value)">
        <option value="neon">Neon</option>
        <option value="carbon">Carbon</option>
        <option value="light">Light</option>
      </select>
    </div>
  </div>

  <div class="layout">
    <!-- COLUNA ESQUERDA -->
    <div class="left-col">

      <!-- ASTROFÍSICA -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Astrofísica</div>
          <div class="card-kicker">Custo por nível em metal, cristal e deutério</div>
        </div>
        <div class="card-section">
          <div class="grid-4">
            <div class="field">
              <label for="astroLevel">Nível</label>
              <input id="astroLevel" type="number" min="0"
                     oninput="updateAstroCost(); markDirty();" />
            </div>
            <div class="field">
              <label>Metal</label>
              <input id="astroMetal" type="text" readonly />
            </div>
            <div class="field">
              <label>Cristal</label>
              <input id="astroCrystal" type="text" readonly />
            </div>
            <div class="field">
              <label>Deutério</label>
              <input id="astroDeut" type="text" readonly />
            </div>
          </div>
        </div>
      </div>

      <!-- RECURSOS & PRODUÇÃO -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Recursos &amp; produção</div>
        </div>
        <div class="card-section">
          <div class="card-kicker">Recursos atuais</div>
          <div class="grid-3">
            <div class="field">
              <label for="curMetal">Metal atual</label>
              <input id="curMetal" type="text"
                     oninput="maskWithSpaces(this); markDirty(); updateStorages();" />
            </div>
            <div class="field">
              <label for="curCrystal">Cristal atual</label>
              <input id="curCrystal" type="text"
                     oninput="maskWithSpaces(this); markDirty(); updateStorages();" />
            </div>
            <div class="field">
              <label for="curDeut">Deutério atual</label>
              <input id="curDeut" type="text"
                     oninput="maskWithSpaces(this); markDirty(); updateStorages();" />
            </div>
          </div>

          <div class="card-kicker" style="margin-top:6px;">Produção diária</div>
          <div class="grid-3">
            <div class="field">
              <label for="prodMetal">Produção metal/dia</label>
              <input id="prodMetal" type="text"
                     oninput="maskWithSpaces(this); markDirty();" />
            </div>
            <div class="field">
              <label for="prodCrystal">Produção cristal/dia</label>
              <input id="prodCrystal" type="text"
                     oninput="maskWithSpaces(this); markDirty();" />
            </div>
            <div class="field">
              <label for="prodDeut">Produção deutério/dia</label>
              <input id="prodDeut" type="text"
                     oninput="maskWithSpaces(this); markDirty();" />
            </div>
          </div>
        </div>
      </div>

      <!-- ARMAZÉNS & CONFIG -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Armazéns &amp; Configuração</div>
        </div>
        <div class="card-section">
          <div class="card-kicker">Nível e capacidade dos armazéns</div>
          <div class="grid-3">
            <div class="field">
              <label for="storLvlM">Armazém de Metal</label>
              <input id="storLvlM" type="number" min="0"
                     oninput="updateStorages(); markDirty();" />
              <input id="storCapM" type="text" readonly />
            </div>
            <div class="field">
              <label for="storLvlC">Armazém de Cristal</label>
              <input id="storLvlC" type="number" min="0"
                     oninput="updateStorages(); markDirty();" />
              <input id="storCapC" type="text" readonly />
            </div>
            <div class="field">
              <label for="storLvlD">Tanque de Deutério</label>
              <input id="storLvlD" type="number" min="0"
                     oninput="updateStorages(); markDirty();" />
              <input id="storCapD" type="text" readonly />
            </div>
          </div>

          <div class="card-kicker" style="margin-top:6px;">Bónus & trocas</div>
          <div class="grid-3">
            <div class="field">
              <label for="storBonus">% Bónus forma de vida (armazém)</label>
              <input id="storBonus" type="number" min="0"
                     oninput="updateStorages(); markDirty();" />
            </div>
            <div class="field">
              <label for="allyClass">Classe da Aliança</label>
              <select id="allyClass" onchange="updateStorages(); markDirty();">
                <option value="warrior">Guerreiros</option>
                <option value="merchant">Comerciantes</option>
                <option value="researcher">Investigadores</option>
              </select>
            </div>
            <div></div>
          </div>

          <div class="grid-3" style="margin-top:6px;">
            <div class="field">
              <label>Taxa de trocas (metal)</label>
              <input id="rateM" type="text" value="3"
                     oninput="clampRates(); markDirty();" />
            </div>
            <div class="field">
              <label>Taxa de trocas (cristal)</label>
              <input id="rateC" type="text" value="2"
                     oninput="clampRates(); markDirty();" />
            </div>
            <div class="field">
              <label>Taxa de trocas (deutério)</label>
              <input id="rateD" type="text" value="1"
                     oninput="clampRates(); markDirty();" />
            </div>
          </div>

          <div class="grid-2" style="margin-top:6px;">
            <div class="field">
              <label for="packDM">Matéria negra por pacote</label>
              <input id="packDM" type="text"
                     oninput="maskWithSpaces(this); markDirty();" />
            </div>
            <div class="field">
              <label for="tradeDM">Matéria negra por troca</label>
              <input id="tradeDM" type="text"
                     oninput="maskWithSpaces(this); markDirty();" />
            </div>
          </div>

          <div class="controls-row">
            <button type="button" class="btn btn-secondary" onclick="resetAll()">Reset</button>
            <button type="button" class="btn btn-primary" onclick="calcular()">Calcular</button>
          </div>
        </div>
      </div>
      <!-- FROTA PARA ABATE / SUCATEIRO -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Frota para abate / sucateiro</div>
          <div class="card-kicker">Pontos perdidos e destroços gerados</div>
        </div>
        <div class="card-section">

          <div class="grid-3">
            <div class="field">
              <label for="debrisRate">% de destroços</label>
              <input id="debrisRate" type="number" min="0" max="100"
                     class="input-small"
                     oninput="onDebrisRateChange();" />
            </div>
          </div>

          <div class="controls-row" style="justify-content:flex-start; margin-top:8px;">
            <select id="shipSelect" style="max-width:260px;">
              <option value="lf">Caça Ligeiro</option>
              <option value="hf">Caça Pesado</option>
              <option value="cr">Cruzador</option>
              <option value="bs">Nave de Batalha</option>
              <option value="bc">Interceptor</option>
              <option value="bom">Bombardeiro</option>
              <option value="des">Destruidor</option>
              <option value="rip">Estrela da Morte</option>
              <option value="expo">Exploradora</option>
              <option value="reap">Ceifeira</option>
              <option value="sc">Cargueiro Pequeno</option>
              <option value="lc">Cargueiro Grande</option>
              <option value="col">Nave de Colonização</option>
              <option value="rec">Reciclador</option>
              <option value="spy">Sonda Espionagem</option>
            </select>

            <button type="button" class="btn btn-sm btn-primary" onclick="addShipRow()">Adicionar nave</button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="clearFleet()">Limpar frota</button>
          </div>

          <div style="overflow-x:auto; margin-top:6px;">
            <table>
              <thead>
                <tr>
                  <th>Nave</th>
                  <th>Qtd</th>
                  <th>Pontos perdidos</th>
                  <th>Dest. Metal</th>
                  <th>Dest. Cristal</th>
                  <th>Dest. Deutério</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="fleetBody"></tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td></td>
                  <td class="narrow"><span id="sumPts"></span></td>
                  <td class="narrow"><span id="sumDM"></span></td>
                  <td class="narrow"><span id="sumDC"></span></td>
                  <td class="narrow"><span id="sumDD"></span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

        </div>
      </div>

    </div> <!-- left-col -->

    <!-- COLUNA DIREITA -->
    <div class="right-col">

      <!-- KPIs -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Resumo rápido</div>
        </div>
        <div class="kpi-grid">
          <div class="kpi">
            <div class="kpi-label">Metal em falta (taxa aplicada)</div>
            <div class="kpi-value" id="kpiMissMSU">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Produção diária em MSU</div>
            <div class="kpi-value" id="kpiProdMSU">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Dias estimados</div>
            <div class="kpi-value" id="kpiDays">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Pontos perdidos (frota)</div>
            <div class="kpi-value" id="kpiPts">0</div>
          </div>
        </div>
      </div>

      <!-- RESUMOS DETALHADOS -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Detalhe da simulação</div>
        </div>
        <div class="card-section">

          <div class="status-block">
            <h3>Estado da astrofísica</h3>
            <div id="statusAstro"></div>
          </div>

          <div class="status-block">
            <h3>Destroços gerados</h3>
            <div id="statusDebris"></div>
          </div>

          <div class="status-block">
            <h3>Totais após recursos + frota</h3>
            <div id="statusTotals"></div>
          </div>

          <div class="status-block">
            <h3>Verificação de capacidade</h3>
            <div id="statusCapacity"></div>
          </div>

          <div class="status-block">
            <h3>Trocas recomendadas (MSU)</h3>
            <div id="statusTrades"></div>
          </div>

          <div class="status-block">
            <h3>Pacotes &amp; Matéria Negra</h3>
            <div id="statusPacks"></div>
          </div>

          <div class="status-block">
            <h3>Notas finais</h3>
            <div id="statusNotes"></div>
          </div>

        </div>
      </div>

    </div> <!-- right-col -->
  </div> <!-- layout -->

  <div class="footer">
    <span>oGame AstroCalculator v2.0 — Wezen @[MaRS] Cosmos.PT | Himalia.PT</span>
  </div>

</div> <!-- page -->
<script>
/* ===========================
   TEMA
   =========================== */
const THEME_KEY = "astroCalc_theme";

function applyTheme(theme) {
  const body = document.body;
  body.classList.remove("theme-neon", "theme-carbon", "theme-light");

  let normalized;
  if (theme === "carbon") normalized = "theme-carbon";
  else if (theme === "light") normalized = "theme-light";
  else normalized = "theme-neon";

  body.classList.add(normalized);

  const sel = document.getElementById("themeSelect");
  if (sel) sel.value = theme;
}

function setTheme(theme) {
  try { localStorage.setItem(THEME_KEY, theme); } catch(e){}
  applyTheme(theme);
}

function loadTheme() {
  let t = "neon";
  try { t = localStorage.getItem(THEME_KEY) || "neon"; } catch(e){}
  applyTheme(t);
}

/* ===========================
   UTILS
   =========================== */
const STORAGE_KEY = "astroCalc_v2_state";

function fmt(n) {
  if (!isFinite(n)) return "0";
  n = Math.round(n);
  const s = Math.abs(n).toString();
  const spaced = s.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  return (n < 0 ? "-" : "") + spaced;
}

function unfmt(str) {
  if (!str) return "";
  return str.toString().replace(/\s+/g, "");
}

function maskWithSpaces(el) {
  let raw = (el.value || "").replace(/\D/g, "");
  if (raw === "") {
    el.value = "";
    return;
  }
  el.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function valIntById(id) {
  const el = document.getElementById(id);
  if (!el) return 0;
  const raw = unfmt(el.value);
  if (raw === "" || isNaN(raw)) return 0;
  return parseInt(raw, 10);
}

function valFloatById(id, defVal) {
  const el = document.getElementById(id);
  if (!el) return defVal || 0;
  let raw = (el.value || "").toString().replace(/\s+/g, "");
  raw = raw.replace(",", ".");
  const v = parseFloat(raw);
  return isNaN(v) ? (defVal || 0) : v;
}

function clampRates() {
  const rM = document.getElementById("rateM");
  const rC = document.getElementById("rateC");
  const rD = document.getElementById("rateD");

  if (rM) {
    let n = parseFloat(rM.value.replace(",", "."));
    if (!isNaN(n)) {
      if (n > 3) rM.value = "3";
      if (n < 0) rM.value = "0";
    }
  }
  if (rC) {
    let n = parseFloat(rC.value.replace(",", "."));
    if (!isNaN(n)) {
      if (n > 2) rC.value = "2";
      if (n < 0) rC.value = "0";
    }
  }
  if (rD) {
    let n = parseFloat(rD.value.replace(",", "."));
    if (!isNaN(n)) {
      if (n > 1) rD.value = "1";
      if (n < 0) rD.value = "0";
    }
  }
}

function collectState() {
  const data = {};
  document.querySelectorAll("input, select").forEach(el => {
    if (!el.id) return;
    if (el.type === "button" || el.readOnly) return;
    data[el.id] = el.value;
  });
  return data;
}

function saveState() {
  try {
    const data = collectState();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {}
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (el && typeof data[id] === "string") el.value = data[id];
    });
  } catch (e) {}
}

function markDirty() {
  const notes = document.getElementById("statusNotes");
  if (!notes) return;
  notes.innerHTML =
    '<div class="pill"><strong>Atenção:</strong> parâmetros alterados — clica em Calcular para atualizar.</div>';
  saveState();
}

/* ===========================
   ARMAZÉNS
   =========================== */
function storageCapBase(level) {
  if (level <= 0) return 10000;
  const k = 20 / 33;
  return 5000 * Math.floor(2.5 * Math.exp(k * level));
}

function storageCap(level) {
  const lfEl = document.getElementById("storBonus");
  let lf = 0;
  if (lfEl) {
    let raw = lfEl.value.replace(",", ".");
    lf = raw === "" ? 0 : parseFloat(raw);
    if (!isFinite(lf)) lf = 0;
  }

  const allyEl = document.getElementById("allyClass");
  let classBonus = 0;
  if (allyEl && allyEl.value === "merchant") classBonus = 10;

  const base = storageCapBase(level);
  const totalBonus = lf + classBonus;
  return Math.round(base * (1 + totalBonus / 100));
}

function updateStorages() {
  const lvlM = parseInt(document.getElementById("storLvlM").value) || 0;
  const lvlC = parseInt(document.getElementById("storLvlC").value) || 0;
  const lvlD = parseInt(document.getElementById("storLvlD").value) || 0;

  const capM = storageCap(lvlM);
  const capC = storageCap(lvlC);
  const capD = storageCap(lvlD);

  document.getElementById("storCapM").value = fmt(capM);
  document.getElementById("storCapC").value = fmt(capC);
  document.getElementById("storCapD").value = fmt(capD);

  const curM = valIntById("curMetal");
  const curC = valIntById("curCrystal");
  const curD = valIntById("curDeut");

  document.getElementById("storCapM").classList.toggle("warning", curM > capM);
  document.getElementById("storCapC").classList.toggle("warning", curC > capC);
  document.getElementById("storCapD").classList.toggle("warning", curD > capD);
}

/* ===========================
   ASTROFÍSICA
   =========================== */
function updateAstroCost() {
  const lvl = parseInt(document.getElementById("astroLevel").value) || 0;
  const mField = document.getElementById("astroMetal");
  const cField = document.getElementById("astroCrystal");
  const dField = document.getElementById("astroDeut");

  if (lvl <= 0) {
    mField.value = cField.value = dField.value = "";
    return;
  }

  const baseM = 4000, baseC = 8000, baseD = 4000, mult = 1.75;
  const factor = Math.pow(mult, lvl - 1);

  const m = Math.round(baseM * factor);
  const c = Math.round(baseC * factor);
  const d = Math.round(baseD * factor);

  mField.value = fmt(m);
  cField.value = fmt(c);
  dField.value = fmt(d);

  markDirty();
}
/* ===========================
   DESTROÇOS / FROTA
   =========================== */
function getDebrisRate() {
  const el = document.getElementById("debrisRate");
  if (!el) return 0.7;
  let v = parseInt(el.value, 10);
  if (isNaN(v)) return 0.7;
  if (v < 0) v = 0;
  if (v > 100) v = 100;
  return v / 100;
}

function onDebrisRateChange() {
  const el = document.getElementById("debrisRate");
  if (!el) return;
  let v = parseInt(el.value, 10);
  if (isNaN(v)) {
    el.classList.add("warning");
    return;
  }
  if (v < 0) v = 0;
  if (v > 100) v = 100;
  el.value = v;
  el.classList.remove("warning");
  updateFleetStats();
  markDirty();
}

const SHIPS = {
  lf:  { name:"Caça Ligeiro",        m:3000,    c:1000,    d:0      },
  hf:  { name:"Caça Pesado",         m:6000,    c:4000,    d:0      },
  cr:  { name:"Cruzador",            m:20000,   c:7000,    d:2000   },
  bs:  { name:"Nave de Batalha",     m:45000,   c:15000,   d:0     },
  bc:  { name:"Interceptor",         m:30000,   c:40000,   d:15000  },
  bom: { name:"Bombardeiro",         m:50000,   c:25000,   d:15000  },
  des: { name:"Destruidor",          m:60000,   c:50000,   d:15000  },
  rip: { name:"Estrela da Morte",    m:5000000, c:4000000, d:1000000},
  expo:{ name:"Exploradora",         m:8000,    c:15000,   d:8000   },
  reap:{ name:"Ceifeira",            m:85000,   c:55000,   d:20000  },
  sc:  { name:"Cargueiro Pequeno",   m:2000,    c:2000,    d:0      },
  lc:  { name:"Cargueiro Grande",    m:6000,    c:6000,    d:0      },
  col: { name:"Nave de Colonização", m:10000,   c:20000,   d:10000  },
  rec: { name:"Reciclador",          m:10000,   c:6000,    d:2000   },
  spy: { name:"Sonda Espionagem",    m:0,       c:1000,    d:0      }
};

function addShipRow() {
  const select = document.getElementById("shipSelect");
  const key = select.value;
  if (!key || !SHIPS[key]) return;

  const ship = SHIPS[key];
  const tbody = document.getElementById("fleetBody");

  const tr = document.createElement("tr");
  tr.dataset.shipKey = key;
  tr.innerHTML = `
    <td>${ship.name}</td>
    <td class="fleet-input-cell">
      <div class="field">
        <input class="narrow" placeholder="Qtd"
               oninput="maskWithSpaces(this); updateFleetStats(); markDirty()">
      </div>
    </td>
    <td class="narrow colPts"></td>
    <td class="narrow colDM"></td>
    <td class="narrow colDC"></td>
    <td class="narrow colDD"></td>
    <td class="narrow">
      <button type="button" class="btn-danger" onclick="removeShipRow(this)">X</button>
    </td>
  `;

  tbody.appendChild(tr);
  updateFleetStats();
  markDirty();
}

function removeShipRow(btn) {
  const tr = btn.closest("tr");
  if (tr) tr.remove();
  updateFleetStats();
  markDirty();
}

function clearFleet() {
  document.getElementById("fleetBody").innerHTML = "";
  updateFleetStats();
  markDirty();
}

function updateFleetStats() {
  const tbody = document.getElementById("fleetBody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const debrisRate = getDebrisRate();

  let sumPts = 0, sumDM = 0, sumDC = 0, sumDD = 0;

  rows.forEach(tr => {
    const key = tr.dataset.shipKey;
    const ship = SHIPS[key];
    if (!ship) return;

    const qtyInput = tr.querySelector("input");
    const qtyRaw = unfmt(qtyInput.value);
    const qty = qtyRaw === "" || isNaN(qtyRaw) ? 0 : parseInt(qtyRaw, 10);

    const ptsCell = tr.querySelector(".colPts");
    const dmCell  = tr.querySelector(".colDM");
    const dcCell  = tr.querySelector(".colDC");
    const ddCell  = tr.querySelector(".colDD");

    if (qty <= 0) {
      ptsCell.textContent = dmCell.textContent =
      dcCell.textContent = ddCell.textContent = "";
      return;
    }

    const ptsPerUnit = (ship.m + ship.c + ship.d) / 1000;
    const pts = ptsPerUnit * qty;

    const dm  = Math.floor(ship.m * qty * debrisRate);
    const dc  = Math.floor(ship.c * qty * debrisRate);
    const dd  = Math.floor(ship.d * qty * debrisRate);

    ptsCell.textContent = fmt(Math.round(pts));
    dmCell.textContent  = fmt(dm);
    dcCell.textContent  = fmt(dc);
    ddCell.textContent  = fmt(dd);

    sumPts += pts;
    sumDM  += dm;
    sumDC  += dc;
    sumDD  += dd;
  });

  document.getElementById("sumPts").textContent = sumPts ? fmt(Math.round(sumPts)) : "";
  document.getElementById("sumDM").textContent  = sumDM  ? fmt(sumDM)  : "";
  document.getElementById("sumDC").textContent  = sumDC  ? fmt(sumDC)  : "";
  document.getElementById("sumDD").textContent  = sumDD  ? fmt(sumDD)  : "";

  return { totalPts: Math.round(sumPts), dm: sumDM, dc: sumDC, dd: sumDD };
}
/* ===========================
   CÁLCULO PRINCIPAL
   =========================== */
function calcular() {

  /* --- Ler valores --- */
  const astroM = valIntById("astroMetal");
  const astroC = valIntById("astroCrystal");
  const astroD = valIntById("astroDeut");

  const curM = valIntById("curMetal");
  const curC = valIntById("curCrystal");
  const curD = valIntById("curDeut");

  const prodM = valIntById("prodMetal");
  const prodC = valIntById("prodCrystal");
  const prodD = valIntById("prodDeut");

  const rateM = Math.min(3, valFloatById("rateM",3));
  const rateC = Math.min(2, valFloatById("rateC",2));
  const rateD = Math.min(1, valFloatById("rateD",1));

  const fleetStats = updateFleetStats();
  const dm = fleetStats.dm, dc = fleetStats.dc, dd = fleetStats.dd;

  /* --- Totais após destroços --- */
  const totalM = curM + dm;
  const totalC = curC + dc;
  const totalD = curD + dd;

  /* --- Faltas --- */
  const faltaM = astroM - totalM;
  const faltaC = astroC - totalC;
  const faltaD = astroD - totalD;

  const missM = Math.max(faltaM, 0);
  const missC = Math.max(faltaC, 0);
  const missD = Math.max(faltaD, 0);

  const extraM = Math.max(-faltaM, 0);
  const extraC = Math.max(-faltaC, 0);
  const extraD = Math.max(-faltaD, 0);

  /* --- Conversão para MSU --- */
  const mFactor = 1;
  const cFactor = rateM / rateC;
  const dFactor = rateM / rateD;

  const missMSU = missM*mFactor + missC*cFactor + missD*dFactor;

  const msuFromM = extraM*mFactor;
  const msuFromC = extraC*cFactor;
  const msuFromD = extraD*dFactor;
  const totalExtraMSU = msuFromM + msuFromC + msuFromD;

  const msuAfterTrades = Math.max(missMSU - totalExtraMSU, 0);

  const prodMSU =
      prodM*mFactor +
      prodC*cFactor +
      prodD*dFactor;

  const metalMSUPerDay = prodM * mFactor;

  /* --- Estimativas --- */
  let diasMSU = null;
  if (missMSU > 0 && prodMSU > 0) {
    diasMSU = missMSU / prodMSU;
  }

  let packs = 0;
  if (missMSU > 0 && metalMSUPerDay > 0) {
    packs = Math.ceil(missMSU / metalMSUPerDay);
  }
  const packDM = valIntById("packDM");
  const dmTotal = packs * packDM;

  /* --- KPIs --- */
  document.getElementById("kpiMissMSU").textContent = fmt(Math.round(missMSU));
  document.getElementById("kpiProdMSU").textContent = fmt(Math.round(prodMSU));
  document.getElementById("kpiPts").textContent = fmt(fleetStats.totalPts);

  const kDays = document.getElementById("kpiDays");
  if (diasMSU !== null) {
    kDays.textContent = "~ " + diasMSU.toFixed(1) + " dias";
  } else {
    kDays.textContent = "0";
  }

  /* ========================
     Estado da Astrofísica
     ======================== */
  const stAstro = document.getElementById("statusAstro");
  if (stAstro) {
    stAstro.innerHTML = "";

    const makeLine = (label, val) => {
      const div = document.createElement("div");
      const s1 = document.createElement("span");
      const s2 = document.createElement("span");
      s1.textContent = label;
      s2.textContent = typeof val === "number" ? fmt(val) : val;
      div.appendChild(s1); div.appendChild(s2);
      return div;
    };

    const metalFromC = missC * cFactor;
    const metalFromD = missD * dFactor;

    stAstro.appendChild(makeLine("Metal em falta:", faltaM));
    stAstro.appendChild(makeLine("Cristal em falta:", faltaC));
    stAstro.appendChild(makeLine("Deutério em falta:", faltaD));
    stAstro.appendChild(makeLine("Metal equivalente do cristal:", Math.round(metalFromC)));
    stAstro.appendChild(makeLine("Metal equivalente do deutério:", Math.round(metalFromD)));
    stAstro.appendChild(makeLine("Custo total em metal (taxa aplicada):", Math.round(missMSU)));
  }

  /* ========================
     Destroços
     ======================== */
  const stDebris = document.getElementById("statusDebris");
  if (stDebris) {
    stDebris.innerHTML = "";

    const makeLine = (label, val) => {
      const div = document.createElement("div");
      const s1 = document.createElement("span");
      const s2 = document.createElement("span");
      s1.textContent = label;
      s2.textContent = fmt(val);
      div.appendChild(s1); div.appendChild(s2);
      return div;
    };

    stDebris.appendChild(makeLine("Metal destroços:", dm));
    stDebris.appendChild(makeLine("Cristal destroços:", dc));
    stDebris.appendChild(makeLine("Deutério destroços:", dd));
  }

  /* ========================
     Totais
     ======================== */
  const stTotals = document.getElementById("statusTotals");
  if (stTotals) {
    stTotals.innerHTML = "";

    const makeLine = (label, val) => {
      const div = document.createElement("div");
      const s1 = document.createElement("span");
      const s2 = document.createElement("span");
      s1.textContent = label;
      s2.textContent = fmt(val);
      div.appendChild(s1); div.appendChild(s2);
      return div;
    };

    stTotals.appendChild(makeLine("Total Metal:", totalM));
    stTotals.appendChild(makeLine("Total Cristal:", totalC));
    stTotals.appendChild(makeLine("Total Deutério:", totalD));
  }

  /* ================================
     Verificação de capacidade (corrigida)
     ================================ */
 const capContainer = document.getElementById("statusCapacity");
if (capContainer) {
  capContainer.innerHTML = "";

  const issues = [];

  function capIssue(label, amount) {
    const row = document.createElement("div");
    row.className = "capacity-row";

    const icon = document.createElement("span");
    icon.className = "cap-icon";
    icon.textContent = "⚠️";

    const lbl = document.createElement("span");
    lbl.className = "cap-label";
    lbl.innerHTML = label;

    const msg = document.createElement("span");
    msg.className = "cap-msg";
    msg.textContent = "recursos excedem a capacidade em";

    const val = document.createElement("span");
    val.className = "cap-value";
    val.textContent = fmt(amount);

    row.appendChild(icon);
    row.appendChild(lbl);
    row.appendChild(msg);
    row.appendChild(val);

    return row;
  }

  // Capacidade
  const lvlM = parseInt(document.getElementById("storLvlM").value) || 0;
  const lvlC = parseInt(document.getElementById("storLvlC").value) || 0;
  const lvlD = parseInt(document.getElementById("storLvlD").value) || 0;

  const capM = storageCap(lvlM);
  const capC = storageCap(lvlC);
  const capD = storageCap(lvlD);

  const curM2 = valIntById("curMetal");
  const curC2 = valIntById("curCrystal");
  const curD2 = valIntById("curDeut");

  const dm2 = dm, dc2 = dc, dd2 = dd;

  // Recursos atuais
  if (curM2 > capM) issues.push(capIssue("Armazém de <strong>Metal</strong>", curM2 - capM));
  if (curC2 > capC) issues.push(capIssue("Armazém de <strong>Cristal</strong>", curC2 - capC));
  if (curD2 > capD) issues.push(capIssue("Tanque de <strong>Deutério</strong>", curD2 - capD));

  // Destroços gerados
  if (dm2 > capM) issues.push(capIssue("Armazém de <strong>Metal</strong>", dm2 - capM));
  if (dc2 > capC) issues.push(capIssue("Armazém de <strong>Cristal</strong>", dc2 - capC));
  if (dd2 > capD) issues.push(capIssue("Tanque de <strong>Deutério</strong>", dd2 - capD));

  if (issues.length === 0) {
    const ok = document.createElement("div");
    ok.className = "capacity-row";
    ok.textContent = "Nenhum problema de capacidade detetado.";
    capContainer.appendChild(ok);
  } else {
    issues.forEach(i => capContainer.appendChild(i));
  }
}


  /* =========================
     Trocas recomendadas
     ========================= */
  const stTrades = document.getElementById("statusTrades");
  if (stTrades) {
    stTrades.innerHTML = "";

    const row = (label, text) => {
      const div = document.createElement("div");
      const s1 = document.createElement("span");
      const s2 = document.createElement("span");
      s1.textContent = label;
      s2.textContent = text;
      div.appendChild(s1); div.appendChild(s2);
      return div;
    };

    const lvlC = parseInt(document.getElementById("storLvlC").value) || 0;
    const lvlD = parseInt(document.getElementById("storLvlD").value) || 0;

    const capC = storageCap(lvlC);
    const capD = storageCap(lvlD);

    const needC = Math.max(astroC - totalC, 0);
    const needD = Math.max(astroD - totalD, 0);

    let blocksC = 0, blocksD = 0;
    let metalForCrystal = 0, metalForDeut = 0;

    if (needC > 0 && capC > 0) {
      blocksC = Math.ceil(needC / capC);
      metalForCrystal = needC * (rateM / rateC);
    }

    if (needD > 0 && capD > 0) {
      blocksD = Math.ceil(needD / capD);
      metalForDeut = needD * (rateM / rateD);
    }

    if (needC === 0 && needD === 0) {
      stTrades.appendChild(row("Trocas necessárias:", "Nenhuma — tens tudo."));
    } else {
      if (needC > 0) {
        stTrades.appendChild(
          row(
            "Metal → Cristal:",
            "Necessário: " + fmt(needC) +
            " cristal (≈ " + blocksC + " trocas; limite " + fmt(capC) + "). Metal: " +
            fmt(Math.round(metalForCrystal))
          )
        );
      }
      if (needD > 0) {
        stTrades.appendChild(
          row(
            "Metal → Deutério:",
            "Necessário: " + fmt(needD) +
            " deutério (≈ " + blocksD + " trocas; limite " + fmt(capD) + "). Metal: " +
            fmt(Math.round(metalForDeut))
          )
        );
      }

      stTrades.appendChild(row("Trocas totais:", blocksC + blocksD));
      stTrades.appendChild(row(
        "Metal total necessário:",
        fmt(Math.round(metalForCrystal + metalForDeut))
      ));
    }
  }

  /* ============================
     Pacotes e Matéria Negra
     ============================ */
  const stPacks = document.getElementById("statusPacks");
  if (stPacks) {
    stPacks.innerHTML = "";

    const makeLine = (label, val) => {
      const div = document.createElement("div");
      const s1 = document.createElement("span");
      const s2 = document.createElement("span");
      s1.textContent = label;
      s2.textContent = fmt(val);
      div.appendChild(s1); div.appendChild(s2);
      return div;
    };

    stPacks.appendChild(makeLine("Custo em metal (taxa aplicada):", Math.round(missMSU)));
    stPacks.appendChild(makeLine("Custo metal/dia equivalente (total):", Math.round(prodMSU)));
    stPacks.appendChild(makeLine("Custo metal/dia equivalente (metal):", Math.round(metalMSUPerDay)));
    stPacks.appendChild(makeLine("Pacotes necessários (aprox.):", packs));

    let dmPerTradeVal = 0;
    const dmEl = document.getElementById("tradeDM");
    if (dmEl) {
      const raw = unfmt(dmEl.value);
      if (raw !== "" && !isNaN(raw)) dmPerTradeVal = parseInt(raw, 10);
    }

    let needC2 = Math.max(astroC - totalC, 0);
    let needD2 = Math.max(astroD - totalD, 0);

    let lvlC2 = parseInt(document.getElementById("storLvlC").value) || 0;
    let lvlD2 = parseInt(document.getElementById("storLvlD").value) || 0;

    let capC2 = storageCap(lvlC2);
    let capD2 = storageCap(lvlD2);

    let blocksC2 = (needC2 > 0 ? Math.ceil(needC2 / capC2) : 0);
    let blocksD2 = (needD2 > 0 ? Math.ceil(needD2 / capD2) : 0);

    let dmTrades = (blocksC2 + blocksD2) * dmPerTradeVal;

    stPacks.appendChild(makeLine("Matéria Negra (Pacotes):", dmTotal));
    stPacks.appendChild(makeLine("Matéria Negra (Trocas):", dmTrades));
    stPacks.appendChild(makeLine("Matéria Negra Total:", dmTotal + dmTrades));
  }

  /* ============================
     Notas finais
     ============================ */
  const stNotes = document.getElementById("statusNotes");
  if (stNotes) {
    stNotes.innerHTML = "";

    if (missMSU <= 0) {
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.innerHTML =
        "<strong>Concluído:</strong> já tens metal suficiente (taxa aplicada) para este nível.";
      stNotes.appendChild(pill);
    } else {
      const pill1 = document.createElement("div");
      pill1.className = "pill danger";
      pill1.innerHTML =
        "<strong>Em falta:</strong> " + fmt(Math.round(missMSU)) + " metal.";
      stNotes.appendChild(pill1);

      if (diasMSU !== null) {
        const pill2 = document.createElement("div");
        pill2.className = "pill";
        pill2.innerHTML =
          "<strong>Tempo estimado:</strong> ~" + diasMSU.toFixed(1) + " dias.";
        stNotes.appendChild(pill2);
      }
    }

    if (fleetStats.totalPts > 0) {
      const pill3 = document.createElement("div");
      pill3.className = "pill";
      pill3.innerHTML =
        "<strong>Pontos perdidos com abate:</strong> " + fmt(fleetStats.totalPts) + ".";
      stNotes.appendChild(pill3);
    }
  }

  updateStorages();
}
/* ===========================
   RESET
   =========================== */
function resetAll() {
  try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}

  document.querySelectorAll("input").forEach(el => {
    if (el.type === "button" || el.readOnly) return;
    el.value = "";
  });

  document.getElementById("rateM").value = "3";
  document.getElementById("rateC").value = "2";
  document.getElementById("rateD").value = "1";

  const ally = document.getElementById("allyClass");
  if (ally) ally.value = "warrior";

  const debris = document.getElementById("debrisRate");
  if (debris) debris.value = "";

  const fleetBody = document.getElementById("fleetBody");
  if (fleetBody) fleetBody.innerHTML = "";

  [
    "statusAstro",
    "statusDebris",
    "statusTotals",
    "statusCapacity",
    "statusTrades",
    "statusPacks",
    "statusNotes"
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = "";
  });

  updateStorages();
  updateAstroCost();
}

/* ===========================
   CARREGAMENTO INICIAL
   =========================== */
document.addEventListener("DOMContentLoaded", () => {
  loadTheme();
  loadState();
  updateStorages();
  updateAstroCost();
});
</script>

</body>
</html>
